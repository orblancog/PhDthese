\chapter{System Test}
\section{Calibration}\label{s:cals}
Calibration factor is obtained per cavity and in the vertical plane $y$ by measuring the position signal change as a function of the systematic cavity displacement. Two factors are used to obtain each calibration : the movers displacement vs voltage setting $C_m$ [$\mu$m/V] and the cavity response vs voltage setting $C_c$ [a.u./V]. Therefore the cavity calibration factor is $C_{bpm}=C_c/C_m$ [a.u./$\mu$m].\par
\subsection{Movers Calibration $C_m$}\label{s:calcm}
Previous to installation, the movers displacement vs Voltage setting was measured per BPM block. An interferometer with better than 1 nm resolution is used to measure the BPM vertical position as in Fig. (\ref{f:interfero}). As the head is located over the BPM, positive displacement implies negative change in the intereferometer lecture. Four cycles are shown in Fig. (\ref{f:fourcycles}), two descending and two rising, on the total dynamic range divided in 100 steps and 3 s between steps.\par
\begin{figure}[!htb]
\centering
\begin{subfigure}[b]{0.3\textwidth}
\includegraphics[scale=0.3,angle=180]{interfero.jpg}\caption{Picture of SIOS interferometer used to test the movers. Precision is better than 1 nm.}\label{f:interfero}
\end{subfigure}\hspace*{1cm}
\begin{subfigure}[b]{0.5\textwidth}
\includegraphics[scale=0.32,angle=-90]{image01.pdf}\caption{Four cycles are performed over the entire dynamic range of movers.}\label{f:fourcycles}
\end{subfigure}\caption{Movers calibration test setup for the vertical plane.}\label{f:cmtest}
\end{figure}
\subsubsection{Block AB movers, Cedrat}
Linearity was tested in the four cycles with feedback. Fig. (\ref{f:Cedratmsteps}) shows the mover step and Fig. (\ref{f:Cedratlinres}) shows the residuals from the linear fitting substraction on each cycle.\par
\begin{figure}[!htb]
 \centering\hspace*{-0.6cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{image24.pdf}\caption{Settling speed with feedback for Cedrat movers.}\label{f:Cedratmsteps}
\end{subfigure}\hspace*{1.5cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{image26e.pdf}\caption{Residual non-linearity (with fb), after substraction of linear fitting on cedrat movers.}\label{f:Cedratlinres}
\end{subfigure}\caption{Block AB movers, linearity test over four cycles.}\label{f:Cedratfeedback}
\end{figure}
The calibration mean from these 4 cycles is $C_{mAB} = (-31.015\pm12)\mu$m/V. This value is valid for ranges were the residual is constant, therefore, it is recommended to use the movers with voltage settings in the middle of the total dynamic range and scans over less than 1 V.\par
The step stability was tested by moving back and forth the voltage setting hundreds of times. Fig. (\ref{f:Cedratstepstab}) shows that 10 nm steps are observable and Fig. (\ref{f:Cedratstab}) shows 1.1 nm of stability on each setting.\par
\begin{figure}[!htb]
 \centering\hspace*{-0.6cm}
\begin{subfigure}{0.4\textwidth}
\includegraphics[angle=-90,scale=0.30]{imagestep12a.pdf}\caption{Minimum voltage setting variation back and forth tested was 0.5 mV.}\label{f:Cedratstepstab}
\end{subfigure}\hspace*{1.5cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{imagestep12.pdf}\caption{Stability at fixed voltage setting.}\label{f:Cedratstab}
\end{subfigure}\caption{Block AB movers minimum step and stability.}\label{f:Cedratstability}
\end{figure}
Coupling effect of horizontal displacement on the vertical plane was also tested. Fig (\ref{f:Cedratcoupling}) shows vertical position variation of 2.5 $\mu$m (1\%) of total horizontal dynamic range.\par
\begin{figure}[!htb]
\centering
\includegraphics[scale=0.32,angle=-90]{image62.pdf}\caption{Horizontal to vertical movers coupling.}\label{f:Cedratcoupling}
\end{figure}
Only the readbacks from strain gauges are available after installation. Results from readback linearity with respect to voltage setting on ranges below 1 V show that readbacks are limited by electrical noise of $0.8$ mV. This noise is gaussian, and its effect can be minimized by averaging over several readings. This noise does not affect stability because the readbacks and the feedback loop are independent.

\subsubsection{Block C movers, PI}
Linearity was tested in the four cycles with feedback. Fig. (\ref{f:PImsteps}) shows the mover step and Fig. (\ref{f:PIlinres}) shows the residuals from the linear fitting substraction on each cycle.\par
\begin{figure}[!htb]
 \centering\hspace*{-0.6cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{image04.pdf}\caption{Settling speed with feedback for PI movers.}\label{f:PImsteps}
\end{subfigure}\hspace*{1.5cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{image06e.pdf}\caption{Residual non-linearity (with fb), after substraction of linear fitting on PI movers.}\label{f:PIlinres}
\end{subfigure}\caption{Block C movers, linearity test over four cycles.}\label{f:PIfeedback}
\end{figure}
The calibration mean from these 4 cycles is $C_{mC} = (30.002\pm7)\mu$m/V. This value is valid for ranges were the residual is constant, therefore, it is recommended to use the movers with voltage settings in the middle of the total dynamic range and/or scans over less than 1 V.\par
The step stability was tested by moving back and forth the voltage setting hundreds of times. Fig. (\ref{f:PIstepstab}) shows that 20 nm steps are observable and Fig. (\ref{f:PIstab}) shows 1.13 nm of stability on each setting.\par
\begin{figure}[!htb]
 \centering\hspace*{-0.6cm}
\begin{subfigure}{0.4\textwidth}
\includegraphics[angle=-90,scale=0.30]{imagestep01a.pdf}\caption{Minimum voltage setting variation back and forth tested was 0.5 mV.}\label{f:PIstepstab}
\end{subfigure}\hspace*{1.5cm}
\begin{subfigure}{0.4\textwidth}
 \includegraphics[angle=-90,scale=0.30]{imagestep01.pdf}\caption{Settling speed with feedback for PI movers.}\label{f:PIstab}
\end{subfigure}\caption{Stability at fixed voltage setting.}\label{f:PIstability}
\end{figure}
Coupling effect of horizontal displacement on the vertical plane was also tested. Fig (\ref{f:PIcoupling}) shows vertical position variation of 3 $\mu$m (1\%) of total horizontal dynamic range.\par
\begin{figure}[!htb]
\centering
\includegraphics[scale=0.32,angle=-90]{image42.pdf}\caption{Horizontal to vertical movers coupling.}\label{f:PIcoupling}
\end{figure}
Only the readbacks from strain gauges are available after installation. Results from readback linearity with respect to voltage setting on ranges below 1 V show that readbacks are limited by electrical noise of $5.3$ mV. This noise is gaussian, and its effect can be minimized by averaging over several readings. This noise does not affect stability because the readbacks and the feedback loop are independent.

\subsection{Cavity response calibration $C_c$}\label{s:calibration}
During beam time the cavity position is systematically changed and the amplitud of the cavity output signal is measured. Calibration is calculated from the movers voltage readbacks and choosing the signal peak from the acquired waveform,  giving the factor $C_c=I'/V$ [a.u./V], and the IQ rotation angle $\phi$.\par
Input signal can be attenuated from 0 dB to 70 dB in order to keep it inside of the electronics linear response and acquisition system limits. The system response with attenuation change can be seen in Fig. (\ref{f:calatt}) where the variation of calibration is withing $\pm5\%$ for charge between $(0.4\sim0.5)\times10^{10}$ particles, except for IPBy at 0 dB. The reason for this is due to saturation of electronics shown in Section \ref{s:dynrange}.
\begin{figure}[!htb]
 \centering\hspace*{-0.6cm}
 \begin{subfigure}{0.4\textwidth}
  \includegraphics[scale=0.3,angle=-90]{image01_calsy.pdf}\caption{Calibrations in the vertical plane for the three BPMs.}\label{f:calsy}
 \end{subfigure}\hspace*{1cm}
\begin{subfigure}{0.4\textwidth}
  \includegraphics[scale=0.3,angle=-90]{image01_calsynorm.pdf}\caption{Vertical calibrations at 30dB att. is unity and other calibrations are scaled down.}\label{f:calsynorm}
 \end{subfigure}\caption{Calibrations as a function of attenuation.}\label{f:calatt}
\end{figure}

\section{Dynamic Range}\label{s:dynrange}
Dynamic range is measured in this section as the movers voltage range where the cavity response is linear within a tolerance, and therefore it can be translated to position using the movers calibration, $c_m$, in Sect. \ref{s:calcm}. It is limited by the linear response of the cavity sensitivity, the processing electronics and the acquisition system.\par
\subsection{Acquisition System}
Every study case has been performed with signals inside the acquisition system dynamic range, described in \ref{s:acqsys}. The initial FONT board has been recently replaced by a dedicated SIS digitizer with larger and configurable voltage range. This is no longer a limitation.\par
\subsection{Processing electronics and cavity sensitivity}
The processing and cavity response are combined in the calibration study showing linearity above $\pm5\%$ in Sect. \ref{s:calibration}. However, Fig. \ref{f:calsynorm} shows that IPBy calibration is outside this range at 0 dB attenuation. In order to explain this behaviour the $Q'$ signals from calibrations are shown in Fig. \ref{f:Qp}, where it is visible the difference between IPAy and IPCy with respect to IPBy. The decay of IPAy and IPCy $Q'$ signals is consistent with system resolution studies shown in Sect. \ref{s:resolution}. However, IPBy $Q'$ signal is close to ($0.2\sim0.3$)V in the attenuation range from 0 to 20 dB.\par% As the $Q'$ sensitivity derives from the $I'$ sensitivity, it shows that the IPBy signal response is constant along the three attenuation levels.\par
\begin{figure}[!htb]
\centering
 \includegraphics[scale=0.3,angle=-90]{image01_Qp.pdf}\caption{Effect of attenuation in $Q'$ signals from calibrations. Errors bars are RMS.}\label{f:Qp}
\end{figure}
In the same way, the IPBy calibration vs charge is shown in Fig. \ref{f:chargescan}, where the calibration values have been normalized to the minimum charge and attenuation is fixed at 10 dB. The calibration constant decays by more than $5\%$ at charges above $0.4\times10^{10}$ particles.\par
Using the non saturated calibration at $0.36\times10^{10}$ and 10 dB att. we obtain an IPBy dynamic range of 0.36 V, equivalent to 11 $\mu$m using $c_{mAB}$, where cavity calibration $c_B$ varies less than $ \pm5\%$.  Similar dynamic ranges, in the order or 8 to 10 $\mu$m, have been found for IPAy and IPCy, however they lack the charge scan.\par
IPBy $Q'$ signal fills up almost all dynamic range at 10 dB attenuation and $0.4\times10^{10}$ particles, and it is saturating the processing electronics at 0 dB.\par
\begin{figure}[!htb]
\centering%\hspace*{-0.6cm}
% \begin{subfigure}{0.4\textwidth}
 \includegraphics[scale=0.3,angle=-90]{image01_Calvscharge.pdf}\caption{IPBy Calibration vs charge normalized to the calibration at minimum charge.}\label{f:chargescan}
% \end{subfigure}\caption{Cavities $Q'$ signal and calibration charge scan for IPBy normalized to the minimum charge.}
% \hspace*{1cm}\\
% \begin{subfigure}{0.4\textwidth}
%  \includegraphics[scale=0.6,angle=0]{IPByCal11_10dB_sample68.pdf}\caption{Calibration at .}\label{f:IPBydynrange}
% \end{subfigure}
\end{figure}
To predict the measured dynamic range of IPBy it is necessary to put extra 6dB of attenuation in the processing electronics gain model (Sect. \ref{s:processing}) . At the moment, it has been attributed to lower than expected sensitivity of the cavities in Section \ref{s:resosensi} and/or cable loss in the processing electronics interconnexion.\par

\section{Resolution}\label{s:resolution}
Resolution is measured in nm using the calibration results from Sect. \ref{s:cals}. It is limited by the cavity sensitivity, the electronics noise floor and the acquisition system resolution.\par
\subsection{Acquisition System}
The acquisition system resolution is specified in Sect. \ref{s:acqsys}. Only the oscilloscopes had lower than required resolution, however, they have already been replaced by a dedicated SIS digitizer. This is no longer a limitation.\par
\subsection{Noise floor and cavity sensitivity}
The BPMs, processing electronics and conexions along the BPM signal path generate noise limiting the minimum detectable waveform. This minimum is estimated by scanning the measured jitter vs the attenuation value.\par
At large attenuations the noise floor is bigger than the BPM signal, while at low attenuations is the opposite. There is an inflection point where both are relevant. The cavity calibration are used to scale it in nm.\par
The jitter acquisition is the measurement of bunch position over several hundreds of pulses with an static BPM position setting. 
The readings from the 3 BPMs are shown in Fig. (\ref{f:resojitter}). Jitter for the three BPMs is in the order of $300\sim400$nm. At 40 dB the limit imposes over the signal and by extrapolation the resolution limit per BPM is 13 nm for IPAy, 11 nm for IPBy, and 23 nm for IPCy at 0 dB.\par
\begin{figure}[!htb]
\centering%\hspace*{-0.6cm}
% \begin{subfigure}{0.4\textwidth}
 \includegraphics[scale=0.3,angle=-90]{image01_jitter.pdf}\caption{Jitter measurement for the 3 BPMs.}\label{f:resojitter}
% \end{subfigure}\hspace*{1cm}
% \begin{subfigure}{0.4\textwidth}
%  \includegraphics[scale=0.3,angle=-90]{image01_noisetot.pdf}\caption{Noise per channel for the 3 BPMs.}\label{f:resonoisetot}
% \end{subfigure}\caption{Resolution extrapolation by jitter measurement for the 3BPMs.}\label{f:resojitternoise}
\end{figure}
It is also clear that IPC shows worst resolution limit that IPA and IPB. Two possibilities arise: the electronics noise is larger for IPC or the sensitivity is lower.\par 
\subsubsection{Noise floor}
Jitter measurement at 60 dB and 70 dB attenuation with $0.4\times10^{10}$ particles shows that after substraction of known gains from first, second down-mixing stages and hybrid the noise floor value varies $\pm1$ dB among BPMs.\par
Although, it can not be considered a direct measurement of the processing noise floor as in \cite{PhysRevSTAB.11.062801} because additional losses are not included, it does indicates that noise floor is similar for the three BPMs and it is not the explanation of the discrepancy seen in Fig. (\ref{f:resojitter}) between IPCy when compared to IPAy and IPBy.\par
A limit of 10 nm resolution per BPM is imposed by the processing electronics noise floor in the current state.\par

\subsubsection{Cavity sensitivity}\label{s:resosensi}
Cavity sensitivity and processing electronics gain change the calibration factor. Due to the 6dB mismatch between the mesured dynamic range measured and predicted for IPBy, as shown in Sect. \ref{s:dynrange}, and the lack of charge scans for IPAy and IPCy, it is not possible to conclude about the total gain without making assumptions.\par
However, the signal decay time from waveforms gives information about the cavity sensitivity. 

\subsection{Resolution by trajectory reconstruction}
The system resolution could be estimated by the reconstruction of beam trajectories. Two BPMs are used to measure the bunch position an to predict the measurement on the third BPM. The residuals from substraction of BPM prediction and measurement will depend on each BPM resolution.\par
\subsubsection{Geometrical method}
As longitudinal distances are know within a $\pm0.1$ mm over 250 mm, i.e. better than 1\% precision, then, geometrical factors can be used to predict the beam trajectory \cite{Nakamura:2008}, assuming that all three BPMs have the same resolution. The advantage of this methodoly is that it is independent from beam optics as it does not fit parameter to do predictions.\par
\begin{figure}[!htb]
\centering%\hspace*{-0.6cm}
% \begin{subfigure}{0.4\textwidth}
 \includegraphics[scale=0.8,angle=0]{3BPM_Measured_Predicted_changing_cals.pdf}\caption{Correlation of the three BPMs measurements and predictions.}\label{f:3BPMpredictions}.
% \end{subfigure}\hspace*{1cm}
% \begin{subfigure}{0.4\textwidth}
%  \includegraphics[scale=0.3,angle=-90]{image01_noisetot.pdf}\caption{Noise per channel for the 3 BPMs.}\label{f:resonoisetot}
% \end{subfigure}\caption{Resolution extrapolation by jitter measurement for the 3BPMs.}\label{f:resojitternoise}
\end{figure}
Fig. (\ref{f:3BPMpredictions}) shows the correlation between the measured and predicted position at $4\times10^{10}$ particles per bunch and 0 dB attenuation, where calibration has been modified by +3.7\%, +10.9\% and -2.8\% for IPAy, IPBy and IPCy respectively in order to obtain 100\% slopes within 2\%.\par
The large correction made in the IPBy calibration could be explained by the results shown in Sect. \ref{s:calibration}, and the others lay within calibration precision limits.\par
The measured jitter and the residuals from substracting the predicted value are gaussian. The jitter values, slopes and correlations of predicted vs measured positions, and geometrical factors are shown in Table \ref{t:resodata}.\par
The resolution per BPM estimated with this method is $(47.4\pm0.7)$ nm.\par
\begin{table}[hbt]
\centering
\begin{tabular}{c||c|c|c}\hline
Parameter & IPAy & IPBy & IPCy\\ \hline\hline
Jitter [$\mu$m] & 0.437 & 0.216 & 0.498\\\hline
Slope & $0.9757\pm0.0044$ & $0.9827\pm0.0062$ & $0.9753\pm0.0085$\\\hline
Correlation & 0.9798 & 0.9626 & 0.9322 \\\hline
Geometrical factor & 0.5457 & 0.7988 & 0.2531\\\hline
\end{tabular}\caption{Results from trajectory reconstruction.}\label{t:resodata}
\end{table}
\subsubsection{Optics Phase Advance}
The optics phase advance $\phi$ is estimated by measurement of position jitter correlations among BPMs and Table \ref{t:phaseadv} shows the result of jitter correlation and phase advance between pairs of BPMs.\par
\begin{table}[htb]
\centering
\begin{tabular}{c||c|c|c}\hline
Parameter & IPAy to IPBy & IPBy to IPCy & IPAy to IPCy\\ \hline\hline
Jitter correlation & 0.84 & -0.24 & -0.69\\\hline
Optics Phase Advance & 33\textdegree & 103\textdegree & 134\textdegree\\\hline
\end{tabular}\caption{Jitter correlation and estimated phase advance for the 3 BPMs.}\label{t:phaseadv}
\end{table}
Jitter can be decompose in cos-like and sin-like jitter, therefore BPM resolution affects separately the trajectory reconstruction of each component due to phase advance. Being $r_{i}$ the measurement resolution at one BPM, and $r_{j}$ and $r_{k}$ the resolutions of BPMs $j,k$ used for extrapolation, the system resolution $r_s$ can be estimated from the individual resolutions by addind in quadrature the reconstruction errors from the cos-like and sine-like components, as in Eq. (\ref{eq:resos}).\par
\begin{equation}
 r_s=\sqrt{(r_{i}+r_{j}|\cos\phi_{ij}|+r_{k}|\cos\phi_{ik}|)^2+(r_{i}+r_{j}|\sin\phi_{ij}|+r_{k}|\sin\phi_{ik}|)^2}\label{eq:resos}
\end{equation}
Using the resolution limits estimated from noise limit for the 3 BPMs, Eq. (\ref{eq:resos}) is used to calculate the system resolution at each BPM. Results are shown in Table \ref{t:resos}.
\begin{table}[htb]
\centering
\begin{tabular}{c||c|c|c}\hline
Parameter & IPAy & IPBy & IPCy\\ \hline\hline
Resolution $r_i$ [nm] & 13 & 11 & 23\\\hline
Resolution $r_s$ [nm] & 52 & 49 & 55\\\hline
\end{tabular}\caption{Estimated resolution limit per BPM and system.}\label{t:resos}
\end{table}
The IPBy system resoltion result is the closest to the geometrical result, this is justified because it has the best individual resolution and the phase advances allow to predict cos-likes almost only from IPAy and sin-likes almost only from IPCy.\par
It is worth noting that the optics here used is an special case where the focus is diluted. With the nominal optics the phase advance between BPMs is close multiples of $\pi$ making the individual resolution to add up linearly and therefore, the system resolution would be 47 nm, matching the geometrical result.
\section{Feedback}
Feedback has been tested by the FONT Group \cite{FONTfb:2015} obtaining a reduction of beam jitter down to 67 nm, compatible with the resolution shown in Section \ref{s:resolution}.


\section{Status and Conclusions}
Table (\ref{t:IPBPMsStatus}) show summary of the current IP-BPMs results
\begin{table}[hbt]
\centering
\begin{tabular}{l|l|l|p{4cm}}\hline
PARAMETER & REQUIREMENT & STATUS & Comments\\\hline\hline
Resolution & $\sim$nm & <50nm & Calibration factors ?\newline BPM sensitivity ?\newline Electronics ? \newline X to Y coupling ?\\\hline
Dynamic Range & $\sim$10$\mu$m + extra & $1\mu$m$\sim3\mu$m at 0db & Linear Response of the Cavity ?\newline Electronics ?\newline No extra for alignment + Q' signal \\\hline
Compatibility & IPBSM, EPICS & In work &Calibration Software OK\newline Jitter analysis Software OK\newline IP-BSM, needs common setup \newline EPICs, data still requires off-line analysis\\\hline
Feedback & Operative & Tested	& \\\hline
\end{tabular}\caption{IPBPMs status.}\label{t:IPBPMsStatus}
\end{table}